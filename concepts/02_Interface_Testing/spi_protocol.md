# SPI (Serial Peripheral Interface) Protocol

## 1. Purpose & Common Uses

* **Goal:** Provides **synchronous, serial communication** between a master device and one or more slave devices, typically over short distances on the same PCB. It's often chosen for its higher potential speed compared to I2C.
* **Common Uses:**
    * Interfacing with Flash Memory chips (for program code or data storage).
    * Reading from and writing to SD Cards.
    * Controlling graphic displays (LCDs, OLEDs).
    * Communicating with various sensors requiring higher throughput.
    * Talking to data converters like ADCs (Analog-to-Digital Converters) and DACs (Digital-to-Analog Converters).
    * Communicating with other microcontrollers or FPGAs.

## 2. Key Characteristics

* **Synchronous:** Uses a clock signal (`SCLK`) generated by the master device to synchronize data transfer.
* **Serial:** Data is transferred one bit at a time.
* **Full-Duplex:** Data can be sent from master-to-slave (`MOSI`) and slave-to-master (`MISO`) *simultaneously* on the same clock cycle.
* **Single Master / Multiple Slaves (Typical):** Most systems have one master controlling one or more slaves.
* **Chip Select / Slave Select (CS/SS):** Uses dedicated lines to select individual slave devices, rather than addresses embedded in the data stream.

## 3. The Signal Lines (Typically 4 Wires + Ground)

* **`SCLK` (Serial Clock):**
    * Clock signal driven by the master.
* **`MOSI` (Master Out, Slave In):**
    * Carries data from the master device *to* the slave device(s).
* **`MISO` (Master In, Slave Out):**
    * Carries data from the selected slave device *back to* the master device.
* **`CS` / `SS` (Chip Select / Slave Select):**
    * Driven by the master. Usually requires one dedicated CS/SS line *per slave device*.
    * Typically **active low**. The master pulls this line LOW for the specific slave it wants to communicate with, enabling that slave's SPI interface. Slaves whose CS/SS lines are HIGH ignore the `SCLK` and `MOSI` signals and keep their `MISO` line in a high-impedance state.

## 4. Basic Transaction Flow

1.  **Select Slave:** Master asserts (usually pulls LOW) the `CS/SS` line corresponding to the desired slave device.
2.  **Clock & Data Transfer:** Master generates a specific number of clock pulses on `SCLK`. For each clock pulse:
    * Master shifts a bit out onto the `MOSI` line.
    * Simultaneously, the selected slave shifts a bit out onto the `MISO` line.
    * (Both master and slave also shift *in* the bit currently present on their respective input lines).
3.  **Deselect Slave:** Master de-asserts (usually pulls HIGH) the `CS/SS` line, ending the transaction with that slave.

## 5. Key Concepts

* **Clock Polarity (CPOL) & Clock Phase (CPHA):**
    * These two settings define the clock's idle state and the clock edge on which data is sampled. They combine to create four distinct **SPI Modes (0, 1, 2, 3)**.
    * **`CPOL=0`**: Clock idles LOW.
    * **`CPOL=1`**: Clock idles HIGH.
    * **`CPHA=0`**: Data sampled on the leading (first) clock edge.
    * **`CPHA=1`**: Data sampled on the trailing (second) clock edge.
    * **Crucial:** The master and the slave device **must** be configured to use the *exact same SPI Mode* for communication to function correctly. This is a very common configuration error.
* **No In-Band Addressing:** Slaves are selected *only* via the dedicated `CS/SS` lines.
* **No ACK/NACK:** The base SPI protocol does not include acknowledgements. Reliability typically relies on the system design or higher-level protocols implemented over SPI (e.g., sending a command then reading a status register).
* **Flexible Data Length:** SPI does not enforce 8-bit byte transfers; the master determines how many clock cycles (and thus bits) are in a transaction.

## 6. Pros and Cons

* **Pros:**
    * Generally much **faster** data rates possible than I2C.
    * **Full-duplex** capability allows simultaneous sending and receiving.
    * Simple protocol logic, less overhead per bit compared to I2C.
    * Highly flexible data frame size (not limited to 8-bit bytes).
* **Cons:**
    * Requires **more signal lines** (minimum 4, plus one additional `CS` line per extra slave).
    * No built-in acknowledgement or flow control.
    * Typically operates with only a single master device.
    * Requires careful configuration of CPOL/CPHA modes on both master and slave.

## 7. Relevance to Testing & Debug

Understanding SPI is important for:

* **Flash Memory Programming:** Essential for loading firmware onto devices during manufacturing tests or development.
* **High-Speed Peripheral Communication:** Testing systems often involve reading from fast ADCs or writing to displays via SPI.
* **Debugging:** Using logic analyzers to capture `SCLK`, `MOSI`, `MISO`, and `CS` signals to diagnose communication problems, including checking for correct SPI mode (CPOL/CPHA) settings.
* **Functional Testing:** Verifying that devices communicate correctly over SPI as part of system-level tests.
